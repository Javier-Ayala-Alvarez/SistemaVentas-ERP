<div class="container mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-body">

      <!-- CABECERA -->
      <h3 class="text-center mb-4">Registro de Producto</h3>

      <form #f="ngForm" novalidate>

        <!-- DATOS GENERALES -->
        <h5 class="border-bottom pb-2 mb-3">Datos generales</h5>

        <div class="row g-3">

          <!-- Nombre -->
          <div class="col-md-6">
            <label class="form-label">Nombre del producto</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="productoNuevo.nombre"
              name="nombre"
              required
              minlength="2"
              maxlength="120"
              #nombre="ngModel"
            />
            <small class="text-danger" *ngIf="nombre.invalid && (nombre.touched || intentoGuardar)">
              El nombre es obligatorio.
            </small>
          </div>

          <!-- Descripción -->
          <div class="col-md-6">
            <label class="form-label">Descripción</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="productoNuevo.descripcion"
              name="descripcion"
              required
              minlength="5"
              maxlength="300"
              #descripcion="ngModel"
            />
            <small class="text-danger" *ngIf="descripcion.invalid && (descripcion.touched || intentoGuardar)">
              La descripción es obligatoria.
            </small>
          </div>

          <!-- Categoría -->
          <div class="col-md-4">
            <label class="form-label">Categoría</label>
            <select
              class="form-select"
              [(ngModel)]="productoNuevo.categoria"
              name="categoria"
              required
              #categoria="ngModel"
            >
              <option [ngValue]="null" disabled>Seleccione una categoría</option>
              <option *ngFor="let c of categorias" [ngValue]="c">
                {{ c.nombre }}
              </option>
            </select>
            <small class="text-danger" *ngIf="categoria.invalid && (categoria.touched || intentoGuardar)">
              La categoría es requerida.
            </small>
          </div>

          <!-- Stock -->
          <div class="col-md-2">
            <label class="form-label">Stock</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="productoNuevo.stock"
              name="stock"
              min="1"
              required
              #stock="ngModel"
            />
            <small class="text-danger" *ngIf="stock.invalid && (stock.touched || intentoGuardar)">
              El stock es obligatorio.
            </small>
          </div>

        </div>

        <!-- IMAGEN -->
        <h5 class="border-bottom pb-2 mt-4 mb-3">Imagen del producto</h5>

        <div class="row align-items-center g-3">
          <div class="col-md-6">
            <input
              type="file"
              class="form-control"
              accept="image/*"
              (change)="onLogoSelect($event)"
            />
          </div>

          <div class="col-md-6 text-center">
            <div class="border rounded p-2" style="height:150px">
              <img
                *ngIf="imagenPreview"
                [src]="imagenPreview"
                class="img-fluid h-100"
              />
              <img
                *ngIf="!imagenPreview && productoNuevo?.nombreImagen"
                [src]="imagenRuta + productoNuevo.nombreImagen"
                class="img-fluid h-100"
              />
              <span *ngIf="!imagenPreview && !productoNuevo?.nombreImagen" class="text-muted">
                Sin imagen
              </span>
            </div>
          </div>
        </div>

        <!-- UNIDADES DE MEDIDA -->
        <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
          <h5>Unidades de medida</h5>
          <button
            type="button"
            class="btn btn-success"
            (click)="openModalAgregar()"
          >
            + Agregar unidad
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover table-striped">
            <thead class="table-dark">
              <tr>
                <th>Unidad</th>
                <th>Abreviatura</th>
                <th>Factor</th>
                <th>Precio Venta</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let u of unidadMedidaProducto; let i = index">
                <td>{{ u.unidadMedida?.nombre }}</td>
                <td>{{ u.unidadMedida?.abreviatura }}</td>
                <td>{{ u.unidadMedida?.factor }}</td>
                <td style="max-width:150px">
                  <input
                    type="number"
                    class="form-control"
                    [(ngModel)]="u.precio"
                    name="precio_{{i}}"
                    min="0"
                    step="0.01"
                  />
                </td>
                <td class="text-center">
                  <button
                    type="button"
                    class="btn btn-danger btn-sm"
                    (click)="eliminarUnidadmedida(u)"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>

              <tr *ngIf="unidadMedidaProducto.length === 0">
                <td colspan="5" class="text-center text-muted">
                  No hay unidades agregadas
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- BOTÓN GUARDAR -->
        <div class="d-grid mt-4">
          <button
            type="button"
            class="btn btn-primary btn-lg"
            (click)="preGuardar(f)"
          >
            Guardar Producto
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
