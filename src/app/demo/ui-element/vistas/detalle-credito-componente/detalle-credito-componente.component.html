<!-- ================= TOASTS ================= -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1200">
  <div *ngFor="let t of toasts" class="toast show align-items-center text-bg-danger border-0 mb-2">
    <div class="d-flex">
      <div class="toast-body">
        {{ t.message }}
      </div>
    </div>
  </div>
</div>

<div class="container-fluid factura-layout px-3 py-2">

  <!-- ================= HEADER ================= -->
  <div class="d-flex align-items-center mb-4">
    <h5 class="fw-bold text-primary mb-0">
      <i class="fas fa-file-invoice-dollar me-2"></i>
      Detalle del Crédito
    </h5>
  </div>

  <form #f="ngForm" class="row g-4" novalidate>

    <!-- ================= CLIENTE ================= -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light small fw-semibold py-2">
          Datos del Cliente
        </div>

        <div class="card-body p-3">

          <!-- Cliente -->
          <div class="input-group input-group-sm mb-4">
            <span class="input-group-text">#</span>
            <input class="form-control" [value]="operacion.cliente?.id" readonly>
            <input class="form-control" [value]="operacion.cliente?.nombre + ' ' + operacion.cliente?.apellido"
              readonly>
          </div>

          <!-- Ubicación -->
          <div class="row g-3">

            <div class="col-4">
              <select class="form-select form-select-sm" name="departamento" required
                [(ngModel)]="operacion.departamento"
                [ngClass]="{'is-invalid': intentoGuardar && !operacion.departamento}">
                <option [ngValue]="null">Departamento *</option>
                <option *ngFor="let d of departamentos" [ngValue]="d">
                  {{ d.nombre }}
                </option>
              </select>
              <div class="invalid-feedback">
                Departamento requerido
              </div>
            </div>

            <div class="col-4">
              <select class="form-select form-select-sm" name="municipio" required [(ngModel)]="operacion.municipio"
                [ngClass]="{'is-invalid': intentoGuardar && !operacion.municipio}">
                <option [ngValue]="null">Municipio *</option>
                <option *ngFor="let m of municipios" [ngValue]="m">
                  {{ m.nombre }}
                </option>
              </select>
              <div class="invalid-feedback">
                Municipio requerido
              </div>
            </div>

            <div class="col-4">
              <select class="form-select form-select-sm" name="distrito" required [(ngModel)]="operacion.distrito"
                [ngClass]="{'is-invalid': intentoGuardar && !operacion.distrito}">
                <option [ngValue]="null">Distrito *</option>
                <option *ngFor="let d of distritos" [ngValue]="d">
                  {{ d.nombre }}
                </option>
              </select>
              <div class="invalid-feedback">
                Distrito requerido
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- ================= OPERACIÓN ================= -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light small fw-semibold py-2">
          Datos de la Operación
        </div>

        <div class="card-body p-3">

          <div class="row g-3 mb-3">

            <div class="col-6">
              <select class="form-select form-select-sm" name="tipoOperacion" required
                [(ngModel)]="operacion.tipoOperacion"
                [ngClass]="{'is-invalid': intentoGuardar && !operacion.tipoOperacion}">
                <option [ngValue]="null">Tipo operación *</option>
                <option *ngFor="let t of tipoOperaciones" [ngValue]="t">
                  {{ t.nombre }}
                </option>
              </select>
              <div class="invalid-feedback">
                Tipo de operación requerido
              </div>
            </div>

            <div class="col-6">
              <select class="form-select form-select-sm" name="sucursal" required [(ngModel)]="operacion.sucursal"
                (ngModelChange)="onSucursalChange($event)"
                [ngClass]="{'is-invalid': intentoGuardar && !operacion.sucursal}">
                <option [ngValue]="null">Sucursal *</option>
                <option *ngFor="let s of sucursales" [ngValue]="s">
                  {{ s.nombre }}
                </option>
              </select>
              <div class="invalid-feedback">
                Sucursal requerida
              </div>
            </div>

          </div>

          <div class="mb-1">
            <select class="form-select form-select-sm" name="caja" required [(ngModel)]="operacion.caja"
              [ngClass]="{'is-invalid': intentoGuardar && !operacion.caja}">
              <option [ngValue]="null">Caja *</option>
              <option *ngFor="let c of cajas" [ngValue]="c">
                {{ c.id }} - {{ c.sucursal?.nombre }}
              </option>
            </select>
            <div class="invalid-feedback">
              Caja requerida
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ================= TABS ================= -->
    <div class="col-12 mt-2">
      <ul ngbNav #nav="ngbNav" class="nav nav-tabs">

        <li ngbNavItem>
          <button ngbNavLink>
            <i class="fas fa-exclamation-circle me-1"></i>
            Deuda actual
          </button>

          <ng-template ngbNavContent>
            <div class="card shadow-sm mt-3">
              <div class="table-responsive">
                <table class="table table-hover table-sm text-center mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Código</th>
                      <th>Fecha</th>
                      <th>Monto</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let c of creditos">
                      <td>{{ c.idOperaciones }}</td>
                      <td>{{ c.fechaElaboracion | date:'dd/MM/yyyy' }}</td>
                      <td class="fw-bold text-danger">
                        {{ c.montoPagado ?? 0 | currency:'USD' }}
                      </td>
                    </tr>
                    <tr class="table-secondary fw-bold">
                      <td colspan="2" class="text-end">TOTAL ADEUDADO</td>
                      <td>{{ totalCredito | currency:'USD' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-template>
        </li>

        <li ngbNavItem>
          <button ngbNavLink>
            <i class="fas fa-history me-1"></i>
            Histórico
          </button>

          <ng-template ngbNavContent>
            <div class="card shadow-sm mt-3">
              <div class="table-responsive">
                <table class="table table-hover table-sm text-center mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Código</th>
                      <th>Fecha</th>
                      <th>Monto</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let c of operaciones">
                      <td>{{ c.id }}</td>
                      <td>{{ c.fechaElaboracion | date:'dd/MM/yyyy HH:mm' }}</td>
                      <td class="fw-bold text-danger">
                        {{ c.total ?? 0 | currency:'USD' }}
                      </td>
                      <td>
                        <div class="d-flex justify-content-center gap-2"><button class="btn btn-outline-danger btn-sm"
                            title="Eliminar" (click)="eliminar(c)"><i class="fas fa-trash-alt"></i></button></div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-template>
        </li>

      </ul>

      <div class="mt-3" [ngbNavOutlet]="nav"></div>
    </div>

    <!-- ================= FOOTER ================= -->
    <div class="col-12 d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
      <button class="btn btn-outline-secondary btn-sm" type="button" (click)="activeModal.dismiss()">
        <i class="fas fa-times me-1"></i>
        Cerrar
      </button>

      <button class="btn btn-primary btn-sm" type="button" (click)="pagarTodo()" [disabled]="totalCredito === 0">
        <i class="fas fa-dollar-sign me-1"></i>
        Pagar crédito
      </button>
    </div>

  </form>
</div>