<div class="modal-header">
  <h5 class="modal-title">Productos</h5>
  <button type="button" class="btn-close" aria-label="Close" (click)="activeModal.dismiss('Cross click')"></button>
</div>

<div class="modal-body">
  <div class="row g-3">
    <!-- Tabla de Productos -->
    <div class="col-md-5">
      <div class="card shadow-sm p-3 rounded h-100 d-flex flex-column">
        <h6 class="mb-3">Lista de Productos</h6>
        <div class="table-responsive" style="max-height: 420px; overflow-y: auto;">
          <table class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th (click)="ordenarPor('nombre')" style="cursor:pointer" class="text-white">
                  Nombre
                  <i class="fas" [ngClass]="order === 'nombre' ? (asc ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'"></i>
                </th>
                <th (click)="ordenarPor('descripcion')" style="cursor:pointer" class="text-white">
                  Descripción
                  <i class="fas" [ngClass]="order === 'descripcion' ? (asc ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'"></i>
                </th>
                <th>Imagen</th>
              </tr>
              <tr>
                <th>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="filtroNombre"
                         (input)="loadProducto()"
                         placeholder="Nombre"
                         style="min-width: 110px;" />
                </th>
                <th>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="filtroDescripcion"
                         (input)="loadProducto()"
                         placeholder="Descripción" />
                </th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of producto"
                  (click)="loadUnidadProducto(data.id)"
                  class="cursor-pointer"
                  style="transition: background-color 0.2s ease;">
                <td>{{ data.nombre }}</td>
                <td>{{ data.descripcion }}</td>
                <td>
                  <img *ngIf="data.nombreImagen"
                       [src]="imagenRuta + data.nombreImagen"
                       class="img-thumbnail"
                       style="max-height: 50px; max-width: 50px;"
                       alt="Imagen producto" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginador -->
        <nav aria-label="Page navigation" class="mt-3">
          <ul class="pagination justify-content-end mb-0">
            <li class="page-item disabled">
              <span class="page-link">Items por página</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Página {{page+1}} de {{totalPages.length}}</span>
            </li>
            <li class="page-item" [class.disabled]="page === 0">
              <button class="page-link" (click)="paginaAnterior()" [disabled]="page === 0" aria-label="Anterior">
                <i class="fas fa-step-backward"></i>
              </button>
            </li>
            <li class="page-item" [class.disabled]="page >= totalPages.length - 1">
              <button class="page-link" (click)="paginaSiguiente()" [disabled]="page >= totalPages.length - 1" aria-label="Siguiente">
                <i class="fas fa-step-forward"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <!-- Tabla de Unidades de Medida -->
    <div class="col-md-7">
      <div class="card shadow-sm p-3 rounded h-100 d-flex flex-column">
        <h6 class="mb-3">Unidades de Medida</h6>
        <div class="table-responsive" style="max-height: 420px; overflow-y: auto;">
          <table class="table table-bordered table-hover align-middle mb-0 text-center">
            <thead class="table-dark">
              <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th style="width: 120px;">Cantidad</th>
                <th style="width: 130px;">Descuento (%)</th>
                <th>Agregar</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let unidad of unidadesMedidaProducto; let i = index">
                <td>{{ unidad.unidadMedida?.abreviatura }}</td>
                <td class="text-start">{{ unidad.unidadMedida?.descripcion }}</td>

                <!-- Precio (solo para compra) -->
                <td *ngIf="identificador === 'compra'">
                  <input type="number"
                         class="form-control form-control-sm"
                         placeholder="Precio"
                         min="0.01"
                         step="any"
                         [(ngModel)]="unidad.precio"
                         [ngModelOptions]="{standalone: true}"
                         #precioCtrl="ngModel"
                         required>
                  <small class="text-danger d-block text-start"
                         *ngIf="precioCtrl.invalid && (precioCtrl.dirty || precioCtrl.touched)">
                    <ng-container *ngIf="precioCtrl.errors?.['required']">El precio es requerido.</ng-container>
                    <ng-container *ngIf="precioCtrl.errors?.['min']">Debe ser mayor a 0.</ng-container>
                  </small>
                </td>
                <td *ngIf="identificador !== 'compra'">{{ unidad.precio | number:'1.2-2' }}</td>

                <!-- Cantidad -->
                <td>
                  <input type="number"
                         class="form-control form-control-sm"
                         placeholder="Cantidad"
                         min="1"
                         step="1"
                         [(ngModel)]="unidad.cantidad"
                         [ngModelOptions]="{standalone: true}"
                         #cantCtrl="ngModel"
                         required>
                  <small class="text-danger d-block text-start"
                         *ngIf="cantCtrl.invalid && (cantCtrl.dirty || cantCtrl.touched)">
                    <ng-container *ngIf="cantCtrl.errors?.['required']">La cantidad es requerida.</ng-container>
                    <ng-container *ngIf="cantCtrl.errors?.['min']">Debe ser al menos 1.</ng-container>
                  </small>
                </td>

                <!-- Descuento -->
                <td>
                  <input type="number"
                         class="form-control form-control-sm"
                         placeholder="%"
                         min="0"
                         max="100"
                         step="0.01"
                         [(ngModel)]="unidad.descuento"
                         [ngModelOptions]="{standalone: true}"
                         #descCtrl="ngModel">
                  <small class="text-danger d-block text-start"
                         *ngIf="descCtrl.invalid && (descCtrl.dirty || descCtrl.touched)">
                    <ng-container *ngIf="descCtrl.errors?.['min']">No puede ser menor que 0%.</ng-container>
                    <ng-container *ngIf="descCtrl.errors?.['max']">No puede exceder 100%.</ng-container>
                  </small>
                </td>

                <!-- Agregar -->
                <td class="text-center">
                  <button type="button"
                          class="btn btn-success btn-sm rounded-circle"
                          (click)="guardar(unidad)"
                          [disabled]="(identificador === 'compra' && (!unidad.precio || unidad.precio <= 0)) ||
                                      (!unidad.cantidad || unidad.cantidad < 1) ||
                                      (unidad.descuento ?? 0) < 0 || (unidad.descuento ?? 0) > 100"
                          title="Agregar producto">
                    <i class="fas fa-check"></i>
                  </button>
                </td>
              </tr>

              <tr *ngIf="!unidadesMedidaProducto || unidadesMedidaProducto.length === 0">
                <td colspan="6" class="text-muted py-3">Seleccione un producto para ver sus unidades.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="activeModal.close('Close click')">Cerrar</button>
</div>

<style>
  /* Hover efecto en filas clicables (tabla productos) */
  tr.cursor-pointer:hover {
    background-color: #e9f5ff;
    cursor: pointer;
  }

  /* Inputs focus */
  input.form-control:focus {
    outline: 2px solid #0d6efd;
    box-shadow: 0 0 6px rgba(13, 110, 253, 0.5);
  }

  /* Botón agregar hover */
  button.btn-success:hover {
    background-color: #198754cc;
  }

  /* Paginación botón deshabilitado */
  .page-item.disabled .page-link {
    cursor: not-allowed;
    opacity: 0.6;
  }
</style>
