<div class="container-fluid factura-layout">

  <!-- ================= HEADER ================= -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="fw-bold mb-0">
      <i class="fas fa-file-invoice me-1 text-primary"></i> Factura
    </h6>
    <span class="badge bg-secondary">
      Nº {{ operacion.nFactura }}
    </span>
  </div>

  <form #f="ngForm" class="row g-2" novalidate>

    <!-- ================= IZQUIERDA ================= -->
    <div class="col-lg-6">
      <div class="card p-2 shadow-sm">

        <!-- Cliente -->
        <div class="mb-2">
          <label class="form-label small">Cliente *</label>
          <div class="input-group input-group-sm">
            <input class="form-control"
                   [(ngModel)]="operacion.cliente!.id"
                   name="cliId"
                   readonly>
            <input class="form-control"
                   [(ngModel)]="operacion.cliente!.nombre"
                   name="cliNombre"
                   readonly>
            <button class="btn btn-primary btn-sm"
                    type="button"
                    (click)="openModalCliente()">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <!-- Validación cliente -->
          <div *ngIf="intentoGuardar && (!operacion.cliente || !operacion.cliente.id)"
               class="text-danger small">
            Seleccionar cliente
          </div>
        </div>

        <!-- Dirección -->
        <input class="form-control form-control-sm mb-2"
               [(ngModel)]="operacion.cliente!.direccion"
               name="direccion"
               readonly
               placeholder="Dirección">

        <!-- Ubicación -->
        <div class="row g-2 mb-2">

          <div class="col-4">
            <select class="form-select form-select-sm"
                    [(ngModel)]="operacion.departamento"
                    name="departamento"
                    required>
              <option [ngValue]="null">Depto *</option>
              <option *ngFor="let d of departamentos" [ngValue]="d">
                {{ d.nombre }}
              </option>
            </select>
            <div *ngIf="intentoGuardar && f.controls['departamento']?.invalid"
                 class="text-danger small">
              Requerido
            </div>
          </div>

          <div class="col-4">
            <select class="form-select form-select-sm"
                    [(ngModel)]="operacion.municipio"
                    name="municipio"
                    required>
              <option [ngValue]="null">Municipio *</option>
              <option *ngFor="let m of municipios" [ngValue]="m">
                {{ m.nombre }}
              </option>
            </select>
            <div *ngIf="intentoGuardar && f.controls['municipio']?.invalid"
                 class="text-danger small">
              Requerido
            </div>
          </div>

          <div class="col-4">
            <select class="form-select form-select-sm"
                    [(ngModel)]="operacion.distrito"
                    name="distrito"
                    required>
              <option [ngValue]="null">Distrito *</option>
              <option *ngFor="let d of distritos" [ngValue]="d">
                {{ d.nombre }}
              </option>
            </select>
            <div *ngIf="intentoGuardar && f.controls['distrito']?.invalid"
                 class="text-danger small">
              Requerido
            </div>
          </div>

        </div>

        <!-- Documentos -->
        <div class="row g-2">
          <div class="col-6">
            <input class="form-control form-control-sm"
                   [(ngModel)]="operacion.cliente!.dui"
                   name="dui"
                   readonly
                   placeholder="DUI">
          </div>
          <div class="col-6">
            <input class="form-control form-control-sm"
                   [(ngModel)]="operacion.cliente!.nit"
                   name="nit"
                   readonly
                   placeholder="NIT">
          </div>
        </div>

      </div>
    </div>

    <!-- ================= DERECHA ================= -->
    <div class="col-lg-6">
      <div class="card p-2 shadow-sm">

        <div class="row g-2 mb-2">
          <div class="col-6">
            <input class="form-control form-control-sm"
                   [(ngModel)]="operacion.vendedor!.username"
                   name="vendedor"
                   readonly
                   placeholder="Vendedor">
          </div>
          <div class="col-6">
            <input type="date"
                   class="form-control form-control-sm"
                   [(ngModel)]="operacion.fechaElaboracion"
                   name="fechaElaboracion"
                   required
                   readonly>
            <div *ngIf="intentoGuardar && f.controls['fechaElaboracion']?.invalid"
                 class="text-danger small">
              Fecha requerida
            </div>
          </div>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <select class="form-select form-select-sm"
                    [(ngModel)]="operacion.tipoOperacion"
                    name="tipoOperacion"
                    required>
              <option [ngValue]="null">Tipo operación *</option>
              <option *ngFor="let t of tipoOperaciones" [ngValue]="t">
                {{ t.nombre }}
              </option>
            </select>
            <div *ngIf="intentoGuardar && f.controls['tipoOperacion']?.invalid"
                 class="text-danger small">
              Requerido
            </div>
          </div>

          <div class="col-6">
            <select class="form-select form-select-sm"
                    [(ngModel)]="operacion.sucursal"
                    name="sucursal"
                    required
                    (ngModelChange)="onSucursalChange($event)">
              <option [ngValue]="null">Sucursal *</option>
              <option *ngFor="let s of sucursales" [ngValue]="s">
                {{ s.nombre }}
              </option>
            </select>
            <div *ngIf="intentoGuardar && f.controls['sucursal']?.invalid"
                 class="text-danger small">
              Requerido
            </div>
          </div>
        </div>

        <select class="form-select form-select-sm mb-2"
                [(ngModel)]="operacion.caja"
                name="caja"
                required>
          <option [ngValue]="null">Caja *</option>
          <option *ngFor="let c of cajas" [ngValue]="c">
            {{ c.id }} - {{ c.sucursal?.nombre }}
          </option>
        </select>

        <div *ngIf="intentoGuardar && (!operacion.caja || !operacion.caja.id)"
             class="text-danger small">
          Seleccionar caja
        </div>

        <button class="btn btn-outline-success btn-sm w-100 mt-2"
                type="button"
                (click)="agregarProducto()">
          <i class="fas fa-plus me-1"></i> Agregar producto
        </button>

      </div>
    </div>

    <!-- ================= TABLA ================= -->
    <div class="col-12">
      <div class="card p-2 shadow-sm table-wrapper">
        <table class="table table-sm table-hover mb-0 text-center">
          <thead class="table-light">
            <tr>
              <th>Cod</th>
              <th>Producto</th>
              <th>Cant</th>
              <th>Desc</th>
              <th>Precio</th>
              <th>IVA</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>

            <tr *ngFor="let d of operacionDetalle">
              <td>{{ d.producto?.id }}</td>
              <td class="text-start">
                {{ d.producto?.nombre }}
                <small class="text-muted">
                  ({{ d.unidadMedida?.descripcion }})
                </small>
              </td>
              <td>{{ d.cantidad }}</td>
              <td>{{ d.descuento }}</td>
              <td class="text-end">{{ d.precioUnitario | currency }}</td>
              <td>0</td>
              <td class="fw-bold text-success">
                {{ (d.cantidad ?? 0) * (d.precioUnitario ?? 0) | currency }}
              </td>
              <td>
                <button class="btn btn-outline-danger btn-sm"
                        (click)="eliminarDetalle(d)">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>

            <tr *ngIf="operacionDetalle.length === 0">
              <td colspan="8" class="text-muted py-2">
                Sin productos
              </td>
            </tr>

          </tbody>
        </table>

        <!-- Validación productos -->
        <div *ngIf="intentoGuardar && operacionDetalle.length === 0"
             class="text-danger small mt-1">
          Agregar al menos un producto
        </div>

      </div>
    </div>

    <!-- ================= FOOTER ================= -->
    <div class="factura-footer">
      <div class="d-flex justify-content-between align-items-center">

        <div>
          <small>Subtotal:</small> {{ operacion.subTotal | number:'1.2-2' }} |
          <small>IVA:</small> {{ operacion.iva | number:'1.2-2' }} |
          <small>Retención:</small> {{ operacion.retencion | number:'1.2-2' }}
        </div>

        <div class="fs-5 fw-bold text-success">
          {{ operacion.total | currency }}
        </div>

        <button class="btn btn-primary btn-sm"
                type="submit"
                (click)="preGuardar(f)">
          Guardar
        </button>

      </div>
    </div>

  </form>
</div>
