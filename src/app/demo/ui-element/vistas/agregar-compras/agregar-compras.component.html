<div class="container mt-4">
  <!-- Cabecera de la Compra -->
  <div class="card shadow-sm p-4 mb-4 rounded">
    <h3 class="mb-4 text-center">Compra</h3>

    <!-- Formulario principal con Template-Driven -->
    <form #f="ngForm" novalidate>

      <!-- Sección de Proveedor y Datos de Factura -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="proveedor">Proveedor</label>
          <div class="input-group">
            <input type="text" class="form-control" [(ngModel)]="operacion.proveedor!.id" name="codigo" placeholder="Código" readonly>
            <input type="text" class="form-control" [(ngModel)]="operacion.proveedor!.nombre" name="nombreProveedor" placeholder="Nombre del proveedor" readonly>
            <button class="btn btn-outline-secondary" type="button" (click)="openModalProveedor()">...</button>
          </div>
        </div>

        <div class="col-md-4">
          <label for="direccion">Dirección</label>
          <input type="text" class="form-control" name="direccion" [(ngModel)]="operacion.proveedor!.direccion" placeholder="Dirección del proveedor" readonly />
        </div>

        <div class="col-md-2">
          <label for="nCompra">Compra N°</label>
          <input type="text" class="form-control" name="nCompra" [(ngModel)]="operacion.nFactura" placeholder="Número de factura" readonly />
        </div>
      </div>

      <!-- Dirección y Ubicación -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="departamento">Departamento</label>
          <select
            [(ngModel)]="operacion.departamento"
            class="form-select"
            id="departamento"
            name="departamento"
            required
            #departamento="ngModel">
            <option [ngValue]="null" selected>Seleccione el departamento</option>
            <option *ngFor="let dato of departamentos" [ngValue]="dato">{{ dato.nombre }}</option>
          </select>
          <small class="text-danger" *ngIf="departamento.invalid && (departamento.dirty || departamento.touched)">
            El departamento es requerido.
          </small>
        </div>

        <div class="col-md-3">
          <label for="municipio">Municipio</label>
          <select
            [(ngModel)]="operacion.municipio"
            class="form-select"
            id="municipio"
            name="municipio"
            required
            #municipio="ngModel">
            <option [ngValue]="null" selected>Seleccione el municipio</option>
            <option *ngFor="let dato of municipios" [ngValue]="dato">{{ dato.nombre }}</option>
          </select>
          <small class="text-danger" *ngIf="municipio.invalid && (municipio.dirty || municipio.touched)">
            El municipio es requerido.
          </small>
        </div>

        <div class="col-md-3">
          <label for="distrito">Distritos</label>
          <select
            [(ngModel)]="operacion.distrito"
            class="form-select"
            id="distrito"
            name="distrito"
            required
            #distrito="ngModel">
            <option [ngValue]="null" selected>Seleccione el distrito</option>
            <option *ngFor="let dato of distritos" [ngValue]="dato">{{ dato.nombre }}</option>
          </select>
          <small class="text-danger" *ngIf="distrito.invalid && (distrito.dirty || distrito.touched)">
            El distrito es requerido.
          </small>
        </div>

        <div class="col-md-3">
          <label for="fechaCompra">Fecha de Compra</label>
          <input
            type="date"
            name="fechaCompra"
            id="fechaCompra"
            [(ngModel)]="operacion.fechaElaboracion"
            class="form-control"
            readonly
            required
            #fechaCompra="ngModel" />
          <small class="text-danger" *ngIf="fechaCompra.invalid && (fechaCompra.dirty || fechaCompra.touched)">
            La fecha de compra es requerida.
          </small>
        </div>
      </div>

      <!-- Otros datos de Compra -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="dui">DUI</label>
          <input type="text" class="form-control" [(ngModel)]="operacion.proveedor!.dui" name="dui" placeholder="DUI del proveedor" readonly />
        </div>
        <div class="col-md-3">
          <label for="nit">NIT</label>
          <input type="text" class="form-control" [(ngModel)]="operacion.proveedor!.nit" name="nit" placeholder="NIT del proveedor" readonly />
        </div>
        <div class="col-md-3">
          <label for="tipoOperacion">Tipo de Operación</label>
          <select
            [(ngModel)]="operacion.tipoOperacion"
            class="form-select"
            id="tipoOperacion"
            name="tipoOperacion"
            required
            #tipoOperacion="ngModel">
            <option [ngValue]="null" selected>Seleccione el tipo de operación</option>
            <option *ngFor="let dato of tipoOperaciones" [ngValue]="dato">{{ dato.nombre }}</option>
          </select>
          <small class="text-danger" *ngIf="tipoOperacion.invalid && (tipoOperacion.dirty || tipoOperacion.touched)">
            El tipo de operación es requerido.
          </small>
        </div>
        <div class="col-md-3">
          <label for="sucursal">Sucursal</label>
          <select
            [(ngModel)]="operacion.sucursal"
            class="form-select"
            id="sucursal"
            name="sucursal"
            required
            #sucursal="ngModel">
            <option [ngValue]="null" selected>Seleccione una sucursal</option>
            <option *ngFor="let dato of sucursales" [ngValue]="dato">{{ dato.nombre }}</option>
          </select>
          <small class="text-danger" *ngIf="sucursal.invalid && (sucursal.dirty || sucursal.touched)">
            La sucursal es requerida.
          </small>
        </div>
      </div>

      <!-- Cuerpo de la Compra (Tabla de Productos) -->
      <div class="card shadow-sm mb-4 p-3 rounded table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Descuento</th>
              <th>Valor Unitario</th>
              <th>Exento</th>
              <th>IVA</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let data of operacionDetalle">
              <td>{{ data.producto?.id }}</td>
              <td>{{ data.producto?.nombre }}</td>
              <td>{{ data.cantidad }}</td>
              <td>{{ data.descuento }}</td>
              <td>{{ data.precioUnitario }}</td>
              <td>{{ 0 }}</td>
              <td>{{ 0 }}</td>
              <td>{{ (data.precioUnitario || 0) * (data.cantidad || 0) }}</td>
              <td>
                <button class="btn btn-danger btn-sm rounded-circle me-2" type="button" (click)="eliminarDetalle(data)">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Validación: al menos un producto -->
        <div class="alert alert-warning py-2" *ngIf="!operacionDetalle || operacionDetalle.length === 0">
          Debes agregar al menos un producto a la compra.
        </div>
      </div>

      <!-- Pie de la Compra (Totales y Botones) -->
      <div class="card shadow-sm p-4 rounded table-responsive">
        <div class="d-flex align-items-center justify-content-between">
          <!-- Botones -->
          <div class="botones d-flex align-items-center col-md-6">
            <button class="btn btn-success me-2" type="button" (click)="openModalProducto()">Agregar Producto</button>
            <button
              class="btn btn-primary me-2"
              type="button"
              (click)="preGuardar(f)"
              [disabled]="f.pending">
              Guardar Compra
            </button>
            <button class="btn btn-warning me-2" type="button">Reimprimir Compra</button>
            <button class="btn btn-danger" type="button">Eliminar Compra</button>
          </div>

          <!-- Totales -->
          <div class="totales col-md-6 d-flex flex-column align-items-end">
            <div class="d-flex align-items-center mb-2">
              <label for="subtotal" class="me-3"><strong>Subtotal:</strong></label>
              <input type="text" class="form-control w-50" id="subtotal" name="subtotal" [(ngModel)]="operacion.subTotal" readonly>
            </div>
            <div class="d-flex align-items-center mb-2">
              <label for="iva" class="me-3"><strong>IVA:</strong></label>
              <input type="text" class="form-control w-50" name="iva" id="iva" [(ngModel)]="operacion.iva" readonly>
            </div>
            <div class="d-flex align-items-center mb-2">
              <label for="retencion" class="me-3"><strong>Retención:</strong></label>
              <input type="text" class="form-control w-50" name="retencion" id="retencion" [(ngModel)]="operacion.retencion" readonly>
            </div>
            <div class="d-flex align-items-center">
              <label for="totalVenta" class="me-3"><strong>Total Venta:</strong></label>
              <input type="text" class="form-control w-50" id="totalVenta" name="totalVenta" [(ngModel)]="operacion.total" readonly>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TOASTS FLOTANTES INDIVIDUALES (arriba derecha) ===== -->
      <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000">
        <div
          *ngFor="let toast of toasts"
          class="toast show bg-danger text-white mb-2 p-3 shadow rounded custom-toast"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
          [attr.data-toast-id]="toast.id"
        >
          <div class="d-flex justify-content-between align-items-center">
            <strong>⚠ {{ toast.message }}</strong>
            <button type="button" class="btn-close btn-close-white ms-3" aria-label="Close" (click)="removeToast(toast.id)"></button>
          </div>
        </div>
      </div>
      <!-- ===== /TOASTS ===== -->

    </form>
  </div>
</div>
