<div class="modal-header">
  <h5 class="modal-title">Caja</h5>
  <button type="button" class="btn-close" aria-label="Close" (click)="activeModal.dismiss('Cross click')"></button>
</div>

<div class="modal-body">
  <div class="container mt-3">
    <form [formGroup]="form" (ngSubmit)="guardar()" novalidate>

      <div class="row">
        <!-- Sucursal -->
        <div class="col-md-6 form-group mb-3">
          <label for="sucursal">Sucursal</label>
          <select class="form-select" id="sucursal" formControlName="sucursal" [disabled]="modoEdicion">
            <option [ngValue]="null">Seleccione una sucursal</option>
            <option *ngFor="let dato of sucursales" [ngValue]="dato">{{ dato.nombre }}</option>
          </select>
          <small class="text-danger" *ngIf="f['sucursal'].touched && f['sucursal'].errors?.['required']">
            La sucursal es requerida.
          </small>
        </div>

        <!-- Fecha de Inicio -->
        <div class="col-md-6 form-group mb-3">
          <label for="fechaInicio">Fecha de Inicio</label>
          <input type="date" class="form-control" id="fechaInicio" formControlName="fechaInicio" [readonly]="modoEdicion">
          <small class="text-danger" *ngIf="f['fechaInicio'].touched && f['fechaInicio'].errors?.['required']">
            La fecha de inicio es requerida.
          </small>
        </div>
      </div>

      <div class="row">
        <!-- Hora de Inicio -->
        <div class="col-md-6 form-group mb-3">
          <label for="horaInicio">Hora de Inicio</label>
          <input type="time" class="form-control" id="horaInicio" formControlName="horaInicio" [readonly]="modoEdicion">
          <small class="text-danger"
                 *ngIf="f['horaInicio'].touched && (f['horaInicio'].errors?.['required'] || f['horaInicio'].errors?.['hhmm'])">
            La hora de inicio es requerida y debe tener formato HH:mm.
          </small>
        </div>

        <!-- Fecha de Cierre -->
        <div class="col-md-6 form-group mb-3">
          <label for="fechaCierre">Fecha de Cierre</label>
          <input type="date" class="form-control" id="fechaCierre" formControlName="fechaCierre" [readonly]="!modoEdicion">
          <small class="text-danger"
                 *ngIf="modoEdicion && f['fechaCierre'].touched && f['fechaCierre'].errors?.['required']">
            La fecha de cierre es requerida en edición.
          </small>
        </div>
      </div>

      <div class="row">
        <!-- Hora de Cierre -->
        <div class="col-md-6 form-group mb-3">
          <label for="horaCierre">Hora de Cierre</label>
          <input type="time" class="form-control" id="horaCierre" formControlName="horaCierre" [readonly]="!modoEdicion">
          <small class="text-danger"
                 *ngIf="modoEdicion && f['horaCierre'].touched && (f['horaCierre'].errors?.['required'] || f['horaCierre'].errors?.['hhmm'])">
            La hora de cierre es requerida en edición y debe tener formato HH:mm.
          </small>
        </div>

        <!-- Efectivo de Apertura -->
        <div class="col-md-6 form-group mb-3">
          <label for="efectivoApertura">Efectivo de Apertura</label>
          <input
            type="number"
            class="form-control"
            id="efectivoApertura"
            formControlName="efectivoApertura"
            [readonly]="modoEdicion"
            min="0"
            step="0.01"
            placeholder="0.00">
          <small class="text-danger"
                 *ngIf="f['efectivoApertura'].touched && (f['efectivoApertura'].errors?.['required'] || f['efectivoApertura'].errors?.['min'])">
            El efectivo de apertura es requerido y debe ser ≥ 0.
          </small>
        </div>
      </div>

      <div class="row">
        <!-- Efectivo de Cierre -->
        <div class="col-md-6 form-group mb-3">
          <label for="efectivoCierre">Efectivo de Cierre</label>
          <input
            type="number"
            class="form-control"
            id="efectivoCierre"
            formControlName="efectivoCierre"
            [readonly]="!modoEdicion"
            min="0"
            step="0.01"
            placeholder="0.00">
          <small class="text-danger"
                 *ngIf="modoEdicion && f['efectivoCierre'].touched && (f['efectivoCierre'].errors?.['required'] || f['efectivoCierre'].errors?.['min'])">
            El efectivo de cierre es requerido en edición y debe ser ≥ 0.
          </small>
        </div>
      </div>

      <!-- Errores de validación cruzada del formulario -->
      <div *ngIf="modoEdicion && form.touched && form.errors" class="alert alert-danger py-1">
        <ng-container *ngIf="form.errors?.['cierreInvalido']">
          Debes completar fecha/hora de inicio y cierre.
        </ng-container>
        <ng-container *ngIf="form.errors?.['cierreNoPosterior']">
          La fecha/hora de cierre debe ser posterior a la de inicio.
        </ng-container>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-2">
        <button type="button" class="btn btn-secondary" (click)="activeModal.close('Close click')">Cerrar</button>
        <button type="submit" class="btn btn-primary" [disabled]="form.invalid || form.pending">
          Guardar Caja
        </button>
      </div>

    </form>
  </div>
</div>
