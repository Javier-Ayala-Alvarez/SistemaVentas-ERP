<!-- ================= HEADER ================= -->
<div class="modal-header text-white">
  <h5 class="modal-title">
    <i class="fas fa-boxes me-2"></i>
    Selección de Productos
  </h5>
  <button class="btn-close btn-close-white"
          (click)="activeModal.dismiss()"></button>
</div>

<!-- ================= BODY ================= -->
<div class="modal-body p-4">

  <!-- FLUJO -->
  <div class="alert alert-info py-2 mb-4 small">
    <strong>1.</strong> Selecciona un producto
    <span class="mx-2">→</span>
    <strong>2.</strong> Configura unidad
    <span class="mx-2">→</span>
    <strong>3.</strong> Agrega al detalle
  </div>

  <div class="row g-4">

    <!-- ========== PRODUCTOS ========== -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">
          Productos
        </div>

        <!-- Filtro -->
        <div class="card-body py-2">
          <input class="form-control form-control-sm"
                 placeholder="Buscar producto..."
                 [(ngModel)]="filtroNombre"
                 (input)="loadProducto()">
        </div>

        <!-- Lista -->
        <div class="table-responsive product-list">
          <table class="table table-hover align-middle mb-0">
            <tbody>
              <tr *ngFor="let p of producto"
                  (click)="seleccionarProducto(p)"
                  [class.selected]="productoSeleccionado?.id === p.id"
                  class="cursor-pointer">
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <img *ngIf="p.nombreImagen"
                         [src]="imagenRuta + p.nombreImagen"
                         class="rounded"
                         width="42">
                    <div>
                      <strong>{{ p.nombre }}</strong>
                      <div class="text-muted small">
                        {{ p.descripcion }}
                      </div>
                    </div>
                  </div>
                </td>
              </tr>

              <tr *ngIf="producto?.length === 0">
                <td class="text-center text-muted py-4">
                  Sin productos
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginador -->
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary"
                  (click)="paginaAnterior()"
                  [disabled]="page === 0">
            <i class="fas fa-angle-left"></i>
          </button>
          <small class="text-muted">
            {{ page + 1 }} / {{ totalPages.length }}
          </small>
          <button class="btn btn-sm btn-outline-secondary"
                  (click)="paginaSiguiente()"
                  [disabled]="page >= totalPages.length - 1">
            <i class="fas fa-angle-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ========== UNIDADES ========== -->
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">
          Unidades de Medida
        </div>

        <div class="table-responsive unit-list">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-secondary text-center">
              <tr>
                <th>Unidad</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Desc %</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let u of unidadesMedidaProducto">

                <!-- Unidad -->
                <td>
                  <strong>{{ u.unidadMedida?.abreviatura }}</strong>
                  <div class="text-muted small">
                    {{ u.unidadMedida?.descripcion }}
                  </div>
                </td>

                <!-- Precio -->
                <td>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">$</span>
                    <input type="number"
                           class="form-control"
                           min="0.01"
                           step="0.01"
                           [(ngModel)]="u.precio"
                           [disabled]="identificador !== 'compra'">
                  </div>
                </td>

                <!-- Cantidad -->
                <td>
                  <input type="number"
                         class="form-control form-control-sm"
                         min="1"
                         [(ngModel)]="u.cantidad">
                </td>

                <!-- Descuento -->
                <td>
                  <input type="number"
                         class="form-control form-control-sm"
                         min="0"
                         max="100"
                         [(ngModel)]="u.descuento">
                </td>

                <!-- Total -->
                <td class="fw-semibold text-success">
                  {{
                    (u.precio || 0) *
                    (u.cantidad || 0) *
                    (1 - ((u.descuento || 0) / 100))
                    | number:'1.2-2'
                  }}
                </td>

                <!-- Acción -->
                <td>
                  <button class="btn btn-success btn-sm px-3"
                          (click)="guardar(u)"
                          [disabled]="!u.cantidad || u.cantidad < 1 ||
                                      (identificador === 'compra' && (!u.precio || u.precio <= 0))">
                    <i class="fas fa-cart-plus me-1"></i>
                    Agregar
                  </button>
                </td>
              </tr>

              <tr *ngIf="!unidadesMedidaProducto || unidadesMedidaProducto.length === 0">
                <td colspan="6" class="text-center text-muted py-4">
                  Seleccione un producto
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ================= FOOTER ================= -->
<div class="modal-footer">
  <button class="btn btn-outline-secondary"
          (click)="activeModal.close()">
    Cerrar
  </button>
</div>

